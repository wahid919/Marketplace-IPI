/*!
 * @package   yii2-grid
 * @author    Kartik Visweswaran <kartikv2@gmail.com>
 * @copyright Copyright &copy; Kartik Visweswaran, Krajee.com, 2014 - 2021
 * @version   3.5.0
 *
 * jQuery methods library for yii2-grid expand row column
 * 
 * Author: Kartik Visweswaran
 * Copyright: 2014 - 2021, Kartik Visweswaran, Krajee.com
 * For more JQuery plugins visit http://plugins.krajee.com
 * For more Yii related demos visit http://demos.krajee.com
 */
var kvExpandRow;!function(e){"use strict";var a=".kvExpandRowColumn",t={isExpanded:function(e){return e.hasClass("kv-state-expanded")&&!e.hasClass("kv-state-disabled")},isCollapsed:function(e){return e.hasClass("kv-state-collapsed")&&!e.hasClass("kv-state-disabled")},setCss:function(e,a){e.length&&e.removeClass(a).addClass(a)},setExpanded:function(e){e.removeClass("kv-state-expanded").addClass("kv-state-collapsed")},setCollapsed:function(e){e.removeClass("kv-state-collapsed").addClass("kv-state-expanded")},handler:function(e,t,n,l){var d=l?t:t.split(" ").join(a+" ")+a;e.length&&e.off(d).on(d,n)}};kvExpandRow=function(a,n){var l,d="kvRowNum_"+n,o=a.gridId,i=a.hiddenFromExport,s=a.detailUrl,r=a.onDetailLoaded,c=a.expandIcon,p=a.collapseIcon,v=a.expandTitle,f=a.collapseTitle,u=a.expandAllTitle,x=a.collapseAllTitle,h=a.expandOneOnly,g=a.enableRowClick,k=a.rowClickExcludedTags,w=a.enableCache,C=a.extraData,$=a.msgDetailLoading,m=i?a.rowCssClass+" skip-export":a.rowCssClass,y=a.animationDuration,E=e("#"+o),A="."+n,b=E.find(".kv-expand-header-cell.kv-batch-toggle"+A),I=b.find(".kv-expand-header-icon"),R=void 0===a.collapseAll?!1:a.collapseAll,T=void 0===a.expandAll?!1:a.expandAll,K=E.find("td.kv-expand-icon-cell"+A+" .kv-expand-row:not(.kv-state-disabled)"),N=K.length,D="kv-expand-detail-loading",j=function(){var a=E.find("td.kv-expand-icon-cell"+A+":first"),t=a&&a.length?a.closest("tr"):"",n=0;return t&&t.length?(t.find("> td").each(function(){"none"!==e(this).css("display")&&n++}),n):0},L=j(),O=function(e){t.setCss(e,D)},P=function(e){if(e.length){var a=isNaN(y)?1e3:y+200;setTimeout(function(){e.removeClass(D)},a)}},S=function(){var e=E.data(d);return e=e?parseInt(e):0,isNaN(e)?0:e},U=function(e){E.data(d,e)},F=function(){var e=S();E.data(d,e+1)},Q=function(){U(K.find(".kv-state-expanded").length),t.setExpanded(I),I.html(p),b.attr("title",x)},_=function(){U(K.find(".kv-state-collapsed").length),t.setCollapsed(I),I.html(c),b.attr("title",u)},q=function(){var o=0,i=0,s=K.length;return E.data(d)||U(0),0===C.length&&(C={}),0===s?void t.setCss(b,"kv-state-disabled"):(K.each(function(){var a=e(this),t=new l(a),n=a.find(">.kv-expand-icon");n.hasClass("kv-state-init-expanded")?(t.expand(!1),o++):n.hasClass("kv-state-init-collapsed")&&(t.collapse(!1),i++),n.removeClass("kv-state-init-expanded kv-state-init-collapsed"),t.run()}),void(b.length&&(s===o?Q():s===i&&_(),t.handler(b,"click",function(){if(!b.hasClass(D)&&0!==K.length){var l=t.isCollapsed(I),d=t.isExpanded(I),o=e.extend(!0,{},a,{expandAll:d,collapseAll:l});O(b),d?(Q(),E.trigger("kvexprow:toggleAll",[C,!1])):l&&(_(),E.trigger("kvexprow:toggleAll",[C,!0])),kvExpandRow(o,n)}}))))};l=function(e){var a=this;a.$element=e,a.init()},l.prototype={constructor:l,init:function(){var e,a=this;a.$row=a.$element.closest("tr"),a.$icon=a.$element.find(">.kv-expand-icon"),a.$detail=a.$element.find(".kv-expanded-row"+A+":first"),a.$cell=a.$icon.closest(".kv-expand-icon-cell"),a.$container=a.$cell.find(".kv-expand-detail:first"),a.vKey=a.$detail.data("key"),a.vInd=a.$detail.data("index"),0===a.$detail.length&&(a.vKey=a.$row.data("key"),e=a.$row.next('tr.kv-expand-detail-row[data-key="'+a.vKey+'"]'),a.$detail=e.find(".kv-expanded-row"))},run:function(){var a=this,n=a.$row,l=a.$cell,d=a.$icon;return T?(t.isCollapsed(d)&&a.load(function(){a.expand(!0),F(),S()>=N&&(P(b),I.focus())}),void(S()>=N&&(P(b),I.focus()))):R?(t.isExpanded(d)&&(a.collapse(),F(),S()>=N&&(P(b),I.focus())),void(S()>=N&&(P(b),I.focus()))):(t.isExpanded(d)&&(s?a.load(function(){a.expand(!1)}):a.expand(!1)),t.handler(l,"click",function(e){d.hasClass("kv-state-disabled")||a.toggle(),e.stopPropagation()}),void t.handler(n,"click",function(t){var n=t.target,l=e(n).length&&e(n).hasClass("kv-disable-click")||-1!==e.inArray(n.nodeName,k);g&&!l&&a.toggle()}))},load:function(a){var t=this,n=t.$cell,l=t.$detail,d=t.vKey,o=t.vInd,i=e.extend({expandRowKey:d,expandRowInd:o},C),c=w?0===l.html().length:!0;return s.length>0&&c?void e.ajax({type:"POST",data:i,url:s,beforeSend:function(){O(n),E.trigger("kvexprow:beforeLoad",[o,d,C]),l.html($)},success:function(e){l.html(e),P(n),"function"==typeof r&&r(),a(),E.trigger("kvexprow:loaded",[o,d,C])},error:function(){l.html('<div class="alert alert-danger">Error fetching data. Please try again later.</div>'),E.trigger("kvexprow:error",[o,d,C]),P(n)}}):(P(n),void("function"==typeof a&&a()))},expand:function(a){var n=this,l=n.$row,d=n.$icon,o=n.$cell,i=n.$detail,r=n.vKey,c=n.vInd,v=s.length>0;if(!t.isExpanded(d)){v||O(o),E.find('tr[data-index="'+c+'"]').remove(),i.hide(),l.after(i);var u='<tr class="kv-expand-detail-row '+m+'" data-key="'+r+'" data-index="'+c+'">';i.wrap('<td colspan="'+L+'">').parent().wrap(u),d.html(p),o.attr("title",f),a?i.slideDown(y,function(){t.setCollapsed(d),i.show()}):(i.show(),t.setCollapsed(d));var x=l.prevAll(),h=l.index()+1;x.push(l),e.each(x,function(a,t){var n=e(t).find("td[rowspan]");e.each(n,function(a,n){var l=parseInt(e(n).attr("rowspan"));e(t).index()+l>h&&e(n).attr("rowspan",l+1)})}),v||P(o)}},collapse:function(a){var n=this,l=n.$row,d=n.$icon,o=n.$cell,i=n.$detail,s=n.$container;t.isCollapsed(d)||(a||O(o),s.html(""),d.html(c),o.attr("title",v),i.slideUp(y,function(){var a=i.closest("tr.kv-expand-detail-row");a.length&&a.before(i).remove(),i.appendTo(s),t.setExpanded(d);var n=l.prevAll();n.push(l);var o=l.index()+1;e.each(n,function(a,t){var n=e(t).find("td[rowspan]");e.each(n,function(a,n){var l=parseInt(e(n).attr("rowspan"));e(t).index()+l>o&&e(n).attr("rowspan",l-1)})})}),a||P(o))},toggle:function(){var a,n=this,d=n.$icon,o=n.$cell,i=!1,s=n.vKey,r=n.vInd;if(!o.hasClass(D))return t.isCollapsed(d)?(a=h&&!R,a&&(K.each(function(){var a=new l(e(this));a.collapse(!0)}),i=!0),n.load(function(){n.expand(!0)}),void(a&&!i||(E.trigger("kvexprow:toggle",[r,s,C,!0]),d.focus()))):void(t.isExpanded(d)&&(n.collapse(),E.trigger("kvexprow:toggle",[r,s,C,!1]),d.focus()))}},q()}}(window.jQuery);